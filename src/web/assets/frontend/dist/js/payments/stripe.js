!function(){"use strict";const e=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t||(t=Math.random().toString(36).substr(2,5)),`${e}.${t}`},t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return window.FormieTranslations&&(e=window.FormieTranslations[e]||e),e.replace(/{([a-zA-Z0-9]+)}/g,((e,i)=>t[i]?t[i]:e))},i=function(e,t){e&&t&&("string"==typeof t&&(t=t.split(" ")),t.forEach((t=>{e.classList.add(t)})))},s=function(e,t){e&&t&&("string"==typeof t&&(t=t.split(" ")),t.forEach((t=>{e.classList.remove(t)})))},r=function(e,t){let i=e.querySelectorAll(`[name="${t}"]`);const s=e.querySelectorAll(`[name="${t}[]"]`);return s.length&&(i=s),i},n=function(e){return`fields[${e=e.replace("{field:","").replace("{","").replace("}","").replace("]","").split("[").join("][")}]`};class o{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.initialized=!1,this.$form=e.$form,this.form=this.$form.form,this.$field=e.$field,this.successClass=this.form.getClasses("success"),this.successMessageClass=this.form.getClasses("successMessage"),this.errorClass=this.form.getClasses("error"),this.errorMessageClass=this.form.getClasses("errorMessage"),this.isVisible=!1;const t=new IntersectionObserver((e=>{0==e[0].intersectionRatio?(this.isVisible=!1,this.initialized&&this.onHide()):(this.isVisible=!0,this.initialized&&this.onShow())}),{root:this.$form});setTimeout((()=>{t.observe(this.$field)}),500)}removeSuccess(){s(this.$field,this.successClass);const e=this.$field.querySelector(`.${this.successMessageClass}`);e&&e.remove()}addSuccess(e){i(this.$field,this.successClass);const t=this.$field.querySelector("[data-field-type] > div");if(!t)return console.error("Unable to find `[data-field-type] > div` to add success message.");const s=document.createElement("div");s.className=this.successMessageClass,s.textContent=e,t.appendChild(s)}removeError(){s(this.$field,this.errorClass);const e=this.$field.querySelector(`.${this.errorMessageClass}`);e&&e.remove()}addError(e){i(this.$field,this.errorClass);const t=this.$field.querySelector("[data-field-type] > div");if(!t)return console.error("Unable to find `[data-field-type] > div` to add error message.");const s=document.createElement("div");s.className=this.errorMessageClass,s.textContent=e,t.appendChild(s),this.submitHandler&&this.submitHandler.formSubmitError()}updateInputs(e,t){const i=this.$field.querySelector(`[name*="${e}"]`);i&&(i.value=t)}getBillingData(){if(!this.billingDetails)return{};const e={};if(this.billingDetails.billingName){const t=this.getFieldValue(this.billingDetails.billingName);t&&(e.name=t)}if(this.billingDetails.billingEmail){const t=this.getFieldValue(this.billingDetails.billingEmail);t&&(e.email=t)}if(this.billingDetails.billingAddress){e.address={};const t=this.getFieldValue(`${this.billingDetails.billingAddress}[address1]`),i=this.getFieldValue(`${this.billingDetails.billingAddress}[address2]`),s=this.getFieldValue(`${this.billingDetails.billingAddress}[address3]`),r=this.getFieldValue(`${this.billingDetails.billingAddress}[city]`),n=this.getFieldValue(`${this.billingDetails.billingAddress}[zip]`),o=this.getFieldValue(`${this.billingDetails.billingAddress}[state]`),l=this.getFieldValue(`${this.billingDetails.billingAddress}[country]`);t&&(e.address.line1=t),i&&(e.address.line2=i),s&&(e.address.line3=s),r&&(e.address.city=r),n&&(e.address.postal_code=n),o&&(e.address.state=o),l&&(e.address.country=l)}new CustomEvent("modifyBillingDetails",{bubbles:!0,detail:{provider:this,billing:e}});return{billing_details:e}}getFieldValue(e){return function(e,t){let i="";t=n(t);const s=r(e,t);return s&&s.forEach((e=>"checkbox"!==e.type&&"radio"!==e.type||e.checked?i=e.value:void 0)),i}(this.$form,e)}getFieldLabel(e){return function(e,t){let i="";t=n(t);const s=r(e,t);return s&&s.forEach((e=>{const t=e.closest("[data-field-type]");if(t){const e=t.querySelector("[data-field-label]");e&&(i=e.childNodes[0].textContent?.trim()??"")}})),i}(this.$form,e)}onShow(){}onHide(){}}function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){h(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function h(e,t,i){return t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t),t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}window.FormiePaymentProvider=o;window.FormieStripe=class extends o{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this.$form=e.$form,this.form=this.$form.form,this.$field=e.$field,this.$input=this.$field.querySelector("[data-fui-stripe-elements]"),this.$placeholder=this.$field.querySelector("[data-fui-stripe-elements-placeholder]"),this.$input?(this.boundEvents=!1,this.publishableKey=e.publishableKey,this.paymentType=e.paymentType,this.billingDetails=e.billingDetails||{},this.hidePostalCode=e.hidePostalCode||!1,this.hideIcon=e.hideIcon||!1,this.initialPaymentInformation=e.initialPaymentInformation||{},this.paymentInformation=function(e){if(void 0!==e)return JSON.parse(JSON.stringify(e))}(this.initialPaymentInformation),this.stripeScriptId="FORMIE_STRIPE_SCRIPT",this.publishableKey?this.initialized=!0:console.error("Missing publishable key for Stripe.")):console.error("Unable to find Stripe Elements placeholder for [data-fui-stripe-elements]")}onShow(){this.loadStripe()}onHide(){this.paymentElement&&(this.paymentElement.destroy(),this.paymentElement=null,this.stripe=null,this.boundEvents=!1,this.form.removeEventListener(e("onFormiePaymentValidate","stripe")),this.form.removeEventListener(e("onAfterFormieSubmit","stripe")),this.form.removeEventListener(e("FormiePaymentStripeConfirm","stripe")))}loadStripe(){try{if(document.getElementById(this.stripeScriptId))(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e5;const i=Date.now(),s=function(r,n){window[e]?r(window[e]):t&&Date.now()-i>=t?n(new Error("timeout")):setTimeout(s.bind(this,r,n),30)};return new Promise(s)})("Stripe").then((()=>{this.initStripe()}));else{const e=document.createElement("script");e.id=this.stripeScriptId,e.src="https://js.stripe.com/v3",e.async=!0,e.defer=!0,e.onload=()=>{this.initStripe()},document.body.appendChild(e)}this.boundEvents||(this.form.addEventListener(this.$form,e("onFormiePaymentValidate","stripe"),this.onValidate.bind(this)),this.form.addEventListener(this.$form,e("onAfterFormieSubmit","stripe"),this.onAfterSubmit.bind(this)),this.form.addEventListener(this.$form,e("FormiePaymentStripeConfirm","stripe"),this.onValidateConfirm.bind(this)),this.boundEvents=!0)}catch(e){console.error(e),this.showPlaceholder(e,"error")}}initStripe(){try{this.stripe=Stripe(this.publishableKey),this.handleDynamicValues()&&this.renderStripe()}catch(e){console.error(e),this.showPlaceholder(e,"error")}}renderStripe(){try{const e=this.isSubscription()?"subscription":"payment",i={},s=a(a({},this.paymentInformation),{},{capture_method:"automatic",mode:e,appearance:{}}),r=new CustomEvent("beforeInit",{bubbles:!0,detail:{stripe:this,elementOptions:s,paymentOptions:i}});if(this.$field.dispatchEvent(r),!s.amount)return void this.showPlaceholder(t("Invalid amount."),"error");if(!s.currency)return void this.showPlaceholder(t("Invalid currency."),"error");this.elements=this.stripe.elements(s),this.paymentElement=this.elements.create("payment",i),this.paymentElement.mount(this.$input),this.hidePlaceholder()}catch(e){console.error(e),this.showPlaceholder(e,"error")}}onValidate(e){"submit"!==this.form.submitAction||e.detail.invalid||(e.preventDefault(),this.submitHandler=e.detail.submitHandler,this.removeError(),this.elements.submit().then((e=>{if(e.error)return this.addError(e.error.message);this.submitHandler.submitForm()})))}showPlaceholder(e,t){this.$placeholder.innerHTML=e,this.$placeholder.classList.remove("fui-hidden"),"error"===t&&this.$placeholder.classList.add("fui-error-message")}hidePlaceholder(){this.$placeholder.classList.add("fui-hidden")}onValidateConfirm(e){const{data:t}=e.detail;this.addLoading();const i=new URL(t.returnUrl);i.searchParams.append("origin",window.location.href),this.form.formTheme&&this.form.formTheme.updateFormHash();("setup"===t.type?this.stripe.confirmSetup:this.stripe.confirmPayment)({elements:this.elements,clientSecret:t.clientSecret,redirect:"if_required",confirmParams:{return_url:i.toString()}}).then((e=>{if(this.removeError(),e.error)return this.removeLoading(),this.addError(e.error.message);this.updateInputs("stripeSubscriptionId",t.subscriptionId),this.updateInputs("stripePaymentIntentId",e.paymentIntent.id),this.submitHandler.submitForm()}))}hasDynamicValue(e){return(this.initialPaymentInformation[e]??null).toString().includes("{field:")??!1}hasDynamicValues(){return this.hasDynamicValue("amount")||this.hasDynamicValue("currency")}checkDynamicValues(){const e=this.initialPaymentInformation?.amount??null,i=this.initialPaymentInformation?.currency??null,s=this.getFieldValue(e),r=this.getFieldValue(i),n=this.getFieldLabel(e),o=this.getFieldLabel(i);if(this.hasDynamicValue("amount")){if(!s)return this.showPlaceholder(t("Provide a value for “{label}” to proceed.",{label:n}),"error"),!1;this.paymentInformation.amount=100*s}if(this.hasDynamicValue("currency")){if(!r)return this.showPlaceholder(t("Provide a value for “{label}” to proceed.",{label:o}),"error"),!1;this.paymentInformation.currency=r.toLowerCase()}return!0}handleDynamicValues(){return!this.hasDynamicValues()||(this.$form.addEventListener("input",function(e,t){let i;return function(){for(var s=arguments.length,r=new Array(s),n=0;n<s;n++)r[n]=arguments[n];clearTimeout(i),i=setTimeout((()=>{e.apply(this,r)}),t)}}((e=>{const t=e.target.name,i=this.initialPaymentInformation?.amount??null,s=this.initialPaymentInformation?.currency??null;t!==n(i)&&t!==n(s)||this.checkDynamicValues()&&(this.hidePlaceholder(),this.elements?this.elements.update(this.paymentInformation):this.renderStripe())}),600)),this.checkDynamicValues())}isSubscription(){return"subscription"===this.paymentType}addLoading(){this.form.formTheme&&this.form.formTheme.addLoading()}removeLoading(){this.form.formTheme&&this.form.formTheme.removeLoading()}onAfterSubmit(e){this.paymentElement&&this.paymentElement.clear(),this.updateInputs("stripePaymentIntentId",""),this.updateInputs("stripeSubscriptionId","")}}}();